name: ğŸ•µï¸ Elite Recon ASM Platform

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: recon-global
  cancel-in-progress: false

jobs:
  recon-cycle:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: âš™ï¸ Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true # Speeds up subsequent runs

      - name: ğŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update 
          sudo apt-get install -y jq

      - name: ğŸ› ï¸ Provision Tools
        run: |
          # Use latest stable versions
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest
          # Amass is heavy; installing via snap/apt is often faster in CI
          sudo apt-get install -y amass 
          sudo cp ~/go/bin/* /usr/local/bin/

      - name: ğŸš€ Execute Recon Engine
        run: |
          chmod +x recon.sh
          # 2h timeout to prevent hung runners
          timeout 2h ./recon.sh

      - name: ğŸ’¬ Intelligent Alerting
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ "${{ job.status }}" == "failure" ]; then
            curl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš¨ *Workflow Failed:* Check GitHub Actions logs."}' $SLACK_WEBHOOK
          elif [ -s slack_alert.txt ]; then
            # The 'jq -Rs .' ensures the text is properly escaped for the JSON payload
            PAYLOAD=$(jq -Rs . < slack_alert.txt)
            curl -X POST -H 'Content-type: application/json' --data "{\"text\": \"ğŸ” *Recon Sync:* \n${PAYLOAD}\"}" $SLACK_WEBHOOK
          fi

      - name: ğŸ’¾ Commit & Atomic Sync
        if: always()
        run: |
          git config --global user.name "Recon-Bot"
          git config --global user.email "bot@ci.recon.com"
          
          # Use rebase to avoid merge commits
          git pull origin main --rebase 
          
          # Only add the db folder
          git add db/
          
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "recon: auto-sync $(date +%F)" && git push origin main)
