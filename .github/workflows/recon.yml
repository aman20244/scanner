name: Continuous External Attack Surface Monitoring

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: asm-global
  cancel-in-progress: false

jobs:
  asm-cycle:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Go Environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Install ASM Tools
        run: |
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/chaos-client/cmd/chaos@latest
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          go install github.com/tomnomnom/anew@latest
          sudo cp ~/go/bin/* /usr/local/bin/

      - name: Execute ASM Engine
        run: |
          chmod +x recon.sh
          timeout 2h ./recon.sh

      - name: Slack Alerting
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ] && [ -f slack_alert.txt ] && [ -s slack_alert.txt ]; then
            PAYLOAD=$(jq -Rs . < slack_alert.txt)
            curl -s -X POST -H "Content-type: application/json" \
              --data "{\"text\": ${PAYLOAD}}" \
              $SLACK_WEBHOOK
          fi

      - name: Commit & Sync State
        if: always()
        run: |
          git config --global user.name "ASM-Bot"
          git config --global user.email "bot@asm.local"

          git add db/

          if ! git diff --cached --quiet; then
            git commit -m "asm: state update $(date +%F)"
            git push
          else
            echo "No changes detected"
          fi
